<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4A148C">
    <title>Duty Tracker Pro</title>

    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">

    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Razorpay SDK -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <style>
        :root {
            --primary: #6200EA;
            --primary-dark: #4A148C;
            --secondary: #03DAC6;
            --bg: #F3F0F7;
            --surface: #FFFFFF;
            --error: #B00020;
            --grad: linear-gradient(135deg, #6200EA, #9575CD);
            --c-present: #43A047;
            --c-leave: #E53935;
            --c-sick: #FB8C00;
            --c-holiday: #8E24AA;
            --c-off: #546E7A;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: #2D2D2D; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* SPLASH SCREEN */
        #splash {
            position: fixed; inset: 0; background: var(--grad); z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;
            transition: all 0.7s cubic-bezier(0.9, 0, 0.1, 1);
        }
        .splash-logo {
            width: 100px; height: 100px; background: rgba(255,255,255,0.2);
            border-radius: 30px; display: flex; align-items: center; justify-content: center;
            animation: bounce 2s infinite; margin-bottom: 20px;
        }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }

        /* HEADER */
        header {
            background: var(--grad); color: white; padding: 20px;
            border-radius: 0 0 35px 35px; box-shadow: 0 10px 25px rgba(98, 0, 234, 0.2); z-index: 10;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .sub-status { font-size: 11px; background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px; font-weight: 600; }
        .month-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.15); padding: 10px; border-radius: 18px;
        }
        .nav-btn { background: white; border: none; width: 35px; height: 35px; border-radius: 12px; color: var(--primary); display: flex; align-items: center; justify-content: center; }

        /* CALENDAR */
        .week-days { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 12px; font-weight: 700; margin-top: 15px; opacity: 0.8; }
        #calendar-grid {
            flex: 1; overflow-y: auto; padding: 15px;
            display: grid; grid-template-columns: repeat(7, 1fr);
            grid-auto-rows: minmax(95px, auto); gap: 10px;
        }
        .day-cell {
            background: white; border-radius: 20px; padding: 8px;
            display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: 0 5px 15px rgba(0,0,0,0.03); border: 2px solid transparent; transition: 0.3s;
        }
        .day-cell.today { border-color: var(--primary); background: #F3EFFF; }
        .day-num { font-size: 15px; font-weight: 700; color: #444; }

        .bg-Present { background: linear-gradient(to bottom right, #66BB6A, #43A047) !important; color: white !important; }
        .bg-Leave { background: linear-gradient(to bottom right, #EF5350, #E53935) !important; color: white !important; }
        .bg-Sick { background: linear-gradient(to bottom right, #FFA726, #FB8C00) !important; color: white !important; }
        .bg-Holiday { background: linear-gradient(to bottom right, #AB47BC, #8E24AA) !important; color: white !important; }
        .bg-Off { background: #ECEFF1 !important; color: #546E7A !important; }
        .badge-ot { font-size: 9px; background: rgba(0,0,0,0.2); padding: 2px 5px; border-radius: 5px; font-weight: 600; text-align: center; }

        /* PROFILE PAGE */
        .full-page {
            position: fixed; inset: 0; background: var(--bg); z-index: 500;
            transform: translateX(100%); transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column;
        }
        .full-page.open { transform: translateX(0); }
        .page-header { background: white; padding: 20px; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .section-card {
            background: white; margin: 15px; padding: 20px; border-radius: 25px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.04);
        }
        .m-input { width: 100%; padding: 14px; border-radius: 15px; border: 1.5px solid #EEE; font-size: 15px; outline: none; margin-top: 5px; }
        .btn-pay {
            background: var(--grad); color: white; border: none; width: 100%; padding: 15px;
            border-radius: 18px; font-weight: 700; font-size: 16px; margin-top: 10px;
            box-shadow: 0 10px 20px rgba(98, 0, 234, 0.3);
        }

        /* DONATION BOX */
        .donate-box { display: flex; flex-direction: column; gap: 12px; margin-top: 15px; align-items: center; }
        .donate-box a { width: 100%; display: flex; justify-content: center; }
        .donate-box img { width: 180px; height: auto; border-radius: 8px; }

        /* MODAL */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1000; display: none; align-items: flex-end; }
        .modal.show { display: flex; }
        .sheet { background: white; width: 100%; padding: 30px; border-radius: 40px 40px 0 0; animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .type-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }
        .t-btn { padding: 12px; border: 1.5px solid #F0F0F0; border-radius: 15px; background: #F9F9F9; font-size: 13px; font-weight: 600; }
        .t-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        #lock-screen { position: fixed; inset: 0; background: white; z-index: 9000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; text-align: center; }
        .hidden { display: none !important; }
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 25px; border-radius: 50px; font-size: 14px; opacity: 0; transition: 0.3s; z-index: 10001; }
        #toast.show { opacity: 1; bottom: 50px; }
    </style>
</head>
<body>

    <!-- SPLASH SCREEN -->
    <div id="splash">
        <div class="splash-logo"><span class="material-icons-round" style="font-size: 50px;">event_note</span></div>
        <h1 style="font-size: 26px; font-weight: 700; letter-spacing: 1px;">Duty Tracker Pro</h1>
        <p style="margin-top: 10px; opacity: 0.8; font-size: 14px;">Made in India â€¢ Nitai Studio</p>
    </div>

    <!-- LOCK SCREEN -->
    <div id="lock-screen" class="hidden">
        <span class="material-icons-round" style="font-size: 80px; color: var(--error);">lock_person</span>
        <h2 style="margin: 20px 0 10px;">Trial Period Expired</h2>
        <p style="color: #666; margin-bottom: 30px;">Your free trial has ended. Subscribe now to continue.</p>
        <button class="btn-pay" style="max-width: 300px;" onclick="sub.pay()">Subscribe - â‚¹10 / Month</button>
    </div>

    <!-- AUTH SCREEN -->
    <div id="auth-screen" class="hidden" style="flex:1; display:flex; align-items:center; justify-content:center; padding:30px;">
        <div style="width:100%; max-width:400px; text-align:center;">
            <div class="splash-logo" style="margin: 0 auto 30px; background: var(--grad); color:white;"><span class="material-icons-round" style="font-size: 50px;">fingerprint</span></div>
            <h2>Login Account</h2>
            <input type="number" id="auth-phone" class="m-input" placeholder="Enter Mobile Number" style="text-align:center; margin-top:20px;">
            <button class="btn-pay" onclick="app.login()">Get Started</button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="hidden">
        <header>
            <div class="header-top">
                <span class="material-icons-round" onclick="ui.togglePage('profile', true)">account_circle</span>
                <span id="trial-badge" class="sub-status">Checking Status...</span>
                <span class="material-icons-round" onclick="ui.togglePage('reports', true)">insights</span>
            </div>
            <div class="month-bar">
                <button class="nav-btn" onclick="cal.move(-1)"><span class="material-icons-round">chevron_left</span></button>
                <h3 id="month-txt">Month 2026</h3>
                <button class="nav-btn" onclick="cal.move(1)"><span class="material-icons-round">chevron_right</span></button>
            </div>
            <div class="week-days"><div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div></div>
        </header>
        <div id="calendar-grid"></div>
    </div>

    <!-- PROFILE PAGE -->
    <div id="profile" class="full-page">
        <div class="page-header">
            <span class="material-icons-round" onclick="ui.togglePage('profile', false)">arrow_back</span>
            <h2>Profile & Support</h2>
        </div>
        <div style="overflow-y:auto; flex:1;">
            <div class="section-card">
                <label style="font-size: 11px; font-weight: 700; color:var(--primary);">ACCOUNT ID</label>
                <p id="uid-disp" style="font-weight: 700; font-size: 18px;">0000000000</p>
            </div>

            <div class="section-card">
                <h3 style="font-size: 14px; margin-bottom:10px;">Configuration</h3>
                <label style="font-size:11px;">Currency</label>
                <select id="set-currency" class="m-input" onchange="settings.save()"><option value="à§³">à§³ BDT</option><option value="â‚¹">â‚¹ INR</option><option value="$">$ USD</option></select>
                <label style="font-size:11px; margin-top:10px; display:block;">Daily Salary</label>
                <input type="number" id="set-salary" class="m-input" onchange="settings.save()">
                <label style="font-size:11px; margin-top:10px; display:block;">OT Rate (Hour)</label>
                <input type="number" id="set-ot-rate" class="m-input" onchange="settings.save()">
            </div>

            <div class="section-card">
                <h3 style="font-size: 14px; text-align: center;">Support Developer</h3>
                <div class="donate-box">
                    <a href="https://buymeacoffee.com/nitaigrp00a" target="_blank"><img src="https://img.shields.io/badge/Buy%20Me%20a%20Coffee-FFDD00?logo=buy-me-a-coffee&logoColor=black&style=for-the-badge" alt="Buy Me a Coffee"></a>
                    <a href="https://ko-fi.com/nitaisarkar" target="_blank"><img src="https://img.shields.io/badge/Ko--fi-Support%20Me-FF5E5B?logo=ko-fi&logoColor=white&style=for-the-badge" alt="Ko-fi"></a>
                    <a href="https://www.patreon.com/cw/NitaiStudio" target="_blank"><img src="https://img.shields.io/badge/Patreon-Support%20Me-F96854?logo=patreon&logoColor=white&style=for-the-badge" alt="Patreon"></a>
                </div>
                <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
                <p style="font-size:13px;">ðŸ“§ <a href="mailto:nitai.grp00@gmail.com" style="color:var(--primary); text-decoration:none;">nitai.grp00@gmail.com</a></p>
                <p style="font-size:13px; margin-top:5px;"><a href="https://nitaistudio.github.io/DutyTrackerPro/policies.html" style="color:var(--primary); text-decoration:none;">Privacy Policy</a></p>
            </div>
            
            <button onclick="localStorage.clear(); location.reload();" style="width:100%; color:red; border:none; background:none; padding:20px; font-weight:700;">LOGOUT</button>
        </div>
    </div>

    <!-- REPORTS PAGE -->
    <div id="reports" class="full-page">
        <div class="page-header"><span class="material-icons-round" onclick="ui.togglePage('reports', false)">arrow_back</span><h2>Reports</h2></div>
        <div style="padding:15px;"><div class="section-card"><input type="date" id="r-start" class="m-input"><input type="date" id="r-end" class="m-input" style="margin-top:10px;"><button class="btn-pay" onclick="reports.gen()">Calculate</button></div><div id="r-out"></div></div>
    </div>

    <!-- ENTRY MODAL -->
    <div id="modal" class="modal" onclick="if(event.target===this) ui.closeModal()">
        <div class="sheet">
            <h3 id="modal-date" style="text-align:center; color:var(--primary-dark);">Date Status</h3>
            <div class="type-selector">
                <button class="t-btn" data-t="Present" onclick="data.setType('Present', this)">Present</button>
                <button class="t-btn" data-t="Leave" onclick="data.setType('Leave', this)">Leave</button>
                <button class="t-btn" data-t="Sick" onclick="data.setType('Sick', this)">Sick</button>
                <button class="t-btn" data-t="Holiday" onclick="data.setType('Holiday', this)">Holiday</button>
                <button class="t-btn" data-t="Off" onclick="data.setType('Off', this)">Off Day</button>
            </div>
            <div style="display:flex; gap:15px;"><input type="number" id="inp-ot" class="m-input" placeholder="OT Hours"><input type="number" id="inp-late" class="m-input" placeholder="Late Mins"></div>
            <button class="btn-pay" onclick="data.save()">Save Status</button>
        </div>
    </div>

    <div id="toast">Message</div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDxqq2PBqrtkTsygyMcIDOvZyx2_-x4QRk",
            authDomain: "duty-tracker-pro.firebaseapp.com",
            databaseURL: "https://duty-tracker-pro-default-rtdb.firebaseio.com",
            projectId: "duty-tracker-pro",
            storageBucket: "duty-tracker-pro.firebasestorage.app",
            messagingSenderId: "716525293622",
            appId: "1:716525293622:web:880f39084c86180fbb0897"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const s = { uid: null, date: new Date(), data: {}, conf: { ws: 0, wo: 0, cur: 'à§³', sal: 0, otr: 0, exp: 0 } };
        let sel = { d: null, t: null };

        window.onload = () => {
            setTimeout(() => {
                const splash = document.getElementById('splash');
                splash.style.opacity = "0"; splash.style.transform = "scale(1.2)";
                setTimeout(() => splash.classList.add('hidden'), 700);
                const id = localStorage.getItem('dt_id');
                if(id) app.start(id); else document.getElementById('auth-screen').classList.remove('hidden');
            }, 2000);
        };

        const app = {
            login: () => {
                const phone = document.getElementById('auth-phone').value.trim();
                if(phone.length < 10) return ui.toast("Invalid number");
                localStorage.setItem('dt_id', phone); app.start(phone);
            },
            start: (id) => {
                s.uid = id; document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('uid-disp').innerText = id;
                db.ref('u/'+id).on('value', snap => {
                    const v = snap.val();
                    if(v) { s.data = v.att || {}; s.conf = { ...s.conf, ...v.conf }; }
                    else { const trial = Date.now() + (3 * 24 * 60 * 60 * 1000); s.conf.exp = trial; db.ref(`u/${id}/conf`).set(s.conf); }
                    app.checkSub(); cal.render(); settings.updateUI();
                });
            },
            checkSub: () => {
                const diff = s.conf.exp - Date.now();
                const daysLeft = Math.ceil(diff / (1000 * 60 * 60 * 24));
                const badge = document.getElementById('trial-badge');
                if(daysLeft > 30) { badge.innerText = "PRO ACTIVE"; badge.style.background = "#4CAF50"; }
                else if (daysLeft > 0) { badge.innerText = `TRIAL: ${daysLeft} DAYS LEFT`; }
                else { document.getElementById('lock-screen').classList.remove('hidden'); document.getElementById('main-app').classList.add('hidden'); }
            }
        };

        const sub = {
            pay: () => {
                const options = {
                    key: "rzp_live_Rz7kQ4RAloCWGp", amount: 1000, currency: "INR", name: "Duty Tracker Pro",
                    description: "30 Days Subscription",
                    handler: (res) => {
                        const curExp = s.conf.exp > Date.now() ? s.conf.exp : Date.now();
                        const newExp = curExp + (30 * 24 * 60 * 60 * 1000);
                        db.ref(`u/${s.uid}/conf/exp`).set(newExp).then(() => ui.toast("Subscription Activated!"));
                    }
                };
                new Razorpay(options).open();
            }
        };

        const cal = {
            getIso: (y, m, d) => `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`,
            render: () => {
                const y = s.date.getFullYear(), m = s.date.getMonth();
                document.getElementById('month-txt').innerText = new Date(y, m).toLocaleString('default', { month: 'long', year: 'numeric' });
                const grid = document.getElementById('calendar-grid'); grid.innerHTML = '';
                const fDay = new Date(y, m, 1).getDay(); const lDate = new Date(y, m+1, 0).getDate();
                for(let i=0; i<fDay; i++) grid.innerHTML += '<div></div>';
                const todayIso = new Date().toISOString().split('T')[0];
                for(let i=1; i<=lDate; i++) {
                    const iso = cal.getIso(y, m, i); const ent = s.data[iso];
                    const cell = document.createElement('div'); cell.className = 'day-cell';
                    if(iso === todayIso) cell.classList.add('today');
                    if(ent && ent.t) cell.classList.add('bg-'+ent.t);
                    else if(new Date(y,m,i).getDay() === parseInt(s.conf.wo)) cell.classList.add('bg-Off');
                    cell.innerHTML = `<span class="day-num">${i}</span>` + (ent && ent.ot ? `<span class="badge-ot">OT: ${ent.ot}h</span>` : '');
                    cell.onclick = () => ui.open(iso, ent); grid.appendChild(cell);
                }
            },
            move: (v) => { s.date.setMonth(s.date.getMonth() + v); cal.render(); }
        };

        const data = {
            setType: (t, btn) => { sel.t = t; document.querySelectorAll('.t-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); },
            save: () => {
                if(!sel.t) return ui.toast("Select status");
                const entry = { t: sel.t, ot: parseFloat(document.getElementById('inp-ot').value) || 0, lt: parseInt(document.getElementById('inp-late').value) || 0 };
                db.ref(`u/${s.uid}/att/${sel.d}`).set(entry).then(() => { ui.toast("Updated"); ui.closeModal(); });
            }
        };

        const settings = {
            updateUI: () => {
                document.getElementById('set-currency').value = s.conf.cur || 'à§³';
                document.getElementById('set-salary').value = s.conf.sal || '';
                document.getElementById('set-ot-rate').value = s.conf.otr || '';
                document.getElementById('set-off').value = s.conf.wo || 0;
            },
            save: () => {
                s.conf.cur = document.getElementById('set-currency').value;
                s.conf.sal = parseFloat(document.getElementById('set-salary').value) || 0;
                s.conf.otr = parseFloat(document.getElementById('set-ot-rate').value) || 0;
                s.conf.wo = document.getElementById('set-off').value;
                db.ref(`u/${s.uid}/conf`).update(s.conf); cal.render();
            }
        };

        const reports = {
            gen: () => {
                const start = document.getElementById('r-start').value, end = document.getElementById('r-end').value;
                if(!start || !end) return ui.toast("Select dates");
                let pres = 0, hol = 0, sick = 0, ot = 0; const sDate = new Date(start), eDate = new Date(end);
                for(let d = new Date(sDate); d <= eDate; d.setDate(d.getDate()+1)) {
                    const iso = d.toISOString().split('T')[0]; const e = s.data[iso];
                    if(e) { if(e.t === 'Present') pres++; if(e.t === 'Holiday') hol++; if(e.t === 'Sick') sick++; ot += (e.ot || 0); }
                }
                const basicPay = (pres + hol + sick) * s.conf.sal, otPay = ot * s.conf.otr;
                document.getElementById('r-out').innerHTML = `<div class="section-card" style="background:var(--grad); color:white;"><h2>${s.conf.cur} ${(basicPay + otPay).toLocaleString()}</h2><p style="font-size:12px;">Days: ${pres+hol+sick} | OT: ${ot}h</p></div>`;
            }
        };

        const ui = {
            open: (d, e) => {
                sel.d = d; sel.t = null; document.getElementById('modal-date').innerText = new Date(d).toDateString();
                document.getElementById('inp-ot').value = e ? e.ot : ''; document.getElementById('inp-late').value = e ? e.lt : '';
                document.querySelectorAll('.t-btn').forEach(b => b.classList.remove('active'));
                if(e) data.setType(e.t, document.querySelector(`[data-t="${e.t}"]`));
                document.getElementById('modal').classList.add('show');
            },
            closeModal: () => document.getElementById('modal').classList.remove('show'),
            togglePage: (id, open) => {
                document.getElementById(id).classList.toggle('open', open);
                if(id === 'reports' && open) { document.getElementById('r-start').value = cal.getIso(s.date.getFullYear(), s.date.getMonth(), 1); document.getElementById('r-end').value = new Date().toISOString().split('T')[0]; }
            },
            toast: (m) => { const t = document.getElementById('toast'); t.innerText = m; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }
        };

        // SERVICE WORKER REGISTRATION
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('PWA SW Registered'))
                .catch(err => console.error('PWA SW Register Failed', err));
            });
        }
    </script>
</body>
</html>