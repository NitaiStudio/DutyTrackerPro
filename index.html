<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Duty Tracker Pro</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Razorpay SDK -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    
    <!-- PayPal SDK -->
    <script src="https://www.paypal.com/sdk/js?client-id=AfOzNhmiQjamiR4usKOUs_hullqnPZaXSTks076L48mXJJaMAn3Rblux_KJsP6_D20xX3s37hnns4p2R&currency=USD&disable-funding=credit,card"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #7F57F1;
            --secondary: #00E5FF;
            --accent: #FF2E63;
            --dark-bg: #0F0E17;
            --surface: #1B1B29;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --gradient: linear-gradient(135deg, #7F57F1, #00E5FF);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--dark-bg);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(127, 87, 241, 0.15) 0%, transparent 25%),
                radial-gradient(circle at 90% 80%, rgba(0, 229, 255, 0.15) 0%, transparent 25%);
            color: #ffffff; overflow-x: hidden; min-height: 100vh; display: flex; flex-direction: column;
        }

        /* --- 1. SPLASH SCREEN (CENTERED) --- */
        #splash { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--dark-bg);
            z-index: 999999; 
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
            transition: opacity 0.8s ease-out;
        }
        .splash-logo-icon {
            font-size: 90px; 
            background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 20px; animation: pulse 2s infinite;
            filter: drop-shadow(0 0 20px rgba(127, 87, 241, 0.5));
        }
        .splash-title { font-size: 32px; font-weight: 800; letter-spacing: 1px; color: white; margin-bottom: 10px; }
        .loader { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--secondary); border-radius: 50%; animation: spin 1s linear infinite; }
        .splash-footer { position: absolute; bottom: 40px; text-align: center; width: 100%; animation: fadeInUp 1s ease-out 0.5s backwards; }
        .made-in { font-size: 13px; color: #888; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 5px; }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 2. AUTH SCREEN (FIXED) --- */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--dark-bg); z-index: 5000;
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }
        .auth-card {
            width: 100%; max-width: 380px; text-align: center;
            background: var(--surface); padding: 40px 30px; border-radius: 24px;
            border: 1px solid var(--border); box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .auth-icon { font-size: 60px; color: var(--primary); margin-bottom: 20px; }
        
        .auth-group { display: flex; flex-direction: column; gap: 15px; margin: 30px 0; }
        
        .country-select {
            width: 100%; padding: 16px; background: rgba(255,255,255,0.05);
            border: 1px solid var(--border); border-radius: 14px;
            color: white; font-size: 16px; outline: none; appearance: none;
        }
        .phone-input {
            width: 100%; padding: 16px; background: rgba(255,255,255,0.05);
            border: 1px solid var(--border); border-radius: 14px;
            color: white; font-size: 18px; outline: none; text-align: center; font-weight: bold;
        }
        .m3-btn {
            width: 100%; padding: 16px; background: var(--gradient); color: white;
            border: none; border-radius: 50px; font-size: 16px; font-weight: bold;
            cursor: pointer; box-shadow: 0 5px 20px rgba(127, 87, 241, 0.4);
        }

        /* --- 3. MAIN UI --- */
        nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 5%; position: sticky; top: 0; z-index: 1000;
            background: rgba(15, 14, 23, 0.9); backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border);
        }
        .logo { font-size: 22px; font-weight: 800; background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        #pwa-install-btn {
            background: rgba(255,255,255,0.1); border: 1px solid var(--border); color: white;
            padding: 8px 16px; border-radius: 50px; font-size: 12px; font-weight: bold;
            display: none; align-items: center; gap: 5px;
        }

        /* --- 4. PAYMENT SCREEN (DUAL) --- */
        #payment-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); backdrop-filter: blur(20px);
            z-index: 99999; display: none; flex-direction: column; 
            align-items: center; justify-content: center; padding: 20px; overflow-y: auto;
        }
        .lock-card {
            background: var(--surface); padding: 25px; border-radius: 24px;
            border: 1px solid var(--accent); box-shadow: 0 0 50px rgba(255, 46, 99, 0.2);
            max-width: 400px; width: 100%; margin-top: 40px; position: relative;
        }
        #pay-close-btn {
            position: absolute; top: 15px; right: 15px;
            background: rgba(255,255,255,0.1); border: none; color: white;
            width: 32px; height: 32px; border-radius: 50%; cursor: pointer;
            display: none; align-items: center; justify-content: center; z-index: 20;
        }
        .plan-box {
            background: rgba(255,255,255,0.03); border: 1px solid var(--border);
            border-radius: 16px; padding: 15px; margin-bottom: 15px;
        }
        .plan-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 12px; border-bottom: 1px solid var(--border); padding-bottom: 8px;
        }
        .pay-btn-rzp {
            width: 100%; padding: 14px; background: #3399cc; color: white; 
            border: none; border-radius: 12px; font-weight: bold; cursor: pointer;
            margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .paypal-container { width: 100%; margin-top: 10px; min-height: 50px; position: relative; z-index: 10; clear: both; }

        /* CALENDAR */
        .app-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        #calendar-grid { padding: 10px; display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .day-cell { 
            height: 80px; background: var(--surface); border-radius: 16px; 
            padding: 5px; position: relative; border: 1px solid transparent; 
            display:flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .bg-Present { background: #00C853 !important; color: white; }
        .bg-Leave { background: #D50000 !important; color: white; }
        .bg-Sick { background: #FF6D00 !important; color: white; }
        .bg-Holiday { background: #AA00FF !important; color: white; }
        .bg-Off { background: #37474F !important; color: white; opacity: 0.6; }

        /* FULL PAGE SETTINGS */
        .full-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark-bg); z-index: 3000; display: none; flex-direction: column; overflow-y: auto; }
        .fp-head { padding: 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 15px; background: var(--surface); }
        .fp-body { padding: 20px; padding-bottom: 100px; }
        
        .profile-card { 
            background: linear-gradient(135deg, rgba(127, 87, 241, 0.2), rgba(0, 229, 255, 0.2)); 
            padding: 25px; border-radius: 20px; border: 1px solid var(--border); 
            margin-bottom: 25px; text-align: center; 
        }

        .input-group { margin-bottom: 15px; }
        .input-label { font-size: 12px; color: #aaa; margin-bottom: 5px; display: block; }
        .settings-input { width: 100%; padding: 14px; background: var(--surface); border: 1px solid var(--border); color: white; border-radius: 12px; font-size: 16px; outline: none; }

        /* DONATE SECTION */
        .donate-section {
            background: rgba(255, 255, 255, 0.03); border-radius: 16px; padding: 20px;
            margin-top: 25px; border: 1px solid var(--border); text-align: center;
        }
        .donate-badges { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 15px; }
        .donate-badges img { height: 35px; border-radius: 6px; cursor: pointer; transition: 0.3s; }
        .donate-badges img:hover { transform: scale(1.05); }

        /* MODAL */
        #modal { position: fixed; bottom: 0; width: 100%; background: var(--surface); padding: 30px 20px; border-radius: 30px 30px 0 0; display: none; z-index: 2000; border-top: 1px solid var(--border); box-shadow: 0 -10px 40px rgba(0,0,0,0.5); }
        .type-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .type-btn { padding: 15px; background: var(--dark-bg); color: white; border: 1px solid var(--border); border-radius: 12px; font-weight: bold; }
        .type-btn.active { border-color: var(--secondary); background: rgba(0, 229, 255, 0.1); }

        /* LEGAL */
        .legal-btn { width: 100%; padding: 15px; text-align: left; background: var(--surface); border: 1px solid var(--border); margin-bottom: 10px; color: #ccc; border-radius: 12px; display: flex; justify-content: space-between; cursor: pointer; }
        #legal-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); backdrop-filter: blur(5px); z-index: 4000; display: none; justify-content: center; align-items: center; padding: 20px; }
        .legal-content { background: var(--surface); width: 100%; max-width: 500px; border-radius: 20px; border: 1px solid var(--border); max-height: 80vh; overflow-y: auto; padding: 25px; position: relative; color: #ccc; line-height: 1.6; }

        #main-app, #auth-screen { display: none; }
    </style>
</head>
<body>

    <!-- 1. SPLASH SCREEN -->
    <div id="splash">
        <span class="material-icons splash-logo-icon">assignment_ind</span>
        <div class="splash-title">Duty Tracker Pro</div>
        <div class="loader"></div>
        <div class="splash-footer">
            <div style="font-size:14px; color:#ccc;">Developer By <b>Nitai Studio</b></div>
            <div class="made-in">Made in India <img src="https://flagcdn.com/w40/in.png" alt="India Flag"></div>
        </div>
    </div>

    <!-- 2. AUTH SCREEN (FIXED) -->
    <div id="auth-screen">
        <div class="auth-card">
            <span class="material-icons" style="font-size:60px; color:var(--primary); margin-bottom:20px;">fingerprint</span>
            <h2 style="margin-bottom:10px;">Welcome</h2>
            <p style="color:#aaa; font-size:14px; margin-bottom:30px;">Login to sync your data securely</p>
            
            <div class="auth-group">
                <select id="country-code" class="country-select">
                    <option value="+91">üáÆüá≥ +91 India</option>
                    <option value="+880">üáßüá© +880 Bangladesh</option>
                    <option value="+1">üá∫üá∏ +1 USA</option>
                    <option value="+44">üá¨üáß +44 UK</option>
                    <option value="+971">üá¶üá™ +971 UAE</option>
                    <option value="+966">üá∏üá¶ +966 Saudi Arabia</option>
                    <option value="+60">üá≤üáæ +60 Malaysia</option>
                    <option value="+65">üá∏üá¨ +65 Singapore</option>
                    <option value="+974">üá∂üá¶ +974 Qatar</option>
                    <option value="+968">üá¥üá≤ +968 Oman</option>
                    <option value="+965">üá∞üáº +965 Kuwait</option>
                    <option value="+973">üáßüá≠ +973 Bahrain</option>
                    <option value="">üåç Other</option>
                </select>
                <input type="number" id="auth-phone" class="phone-input" placeholder="Enter Mobile Number">
            </div>
            
            <button class="m3-btn" onclick="app.login()">Verify & Continue</button>
        </div>
    </div>

    <!-- 3. PAYMENT SCREEN -->
    <div id="payment-screen">
        <div class="lock-card">
            <button id="pay-close-btn" onclick="document.getElementById('payment-screen').style.display='none'"><i class="fas fa-times"></i></button>
            <i class="fas fa-crown" style="font-size:50px; color:var(--accent); margin-bottom:15px; display:block; text-align:center;"></i>
            <h2 style="margin-bottom:10px; color:white; text-align:center;">Premium Access</h2>
            <p style="color:#aaa; font-size:13px; margin-bottom:25px; text-align:center;">7 Days Free Trial included. Renew to continue.</p>
            
            <!-- Monthly -->
            <div class="plan-box">
                <div class="plan-header"><span class="plan-title">Monthly (30 Days)</span><span class="plan-price">‚Çπ5 / $0.10</span></div>
                <button class="pay-btn-rzp" onclick="pay.razorpay(5, 'monthly')"><i class="fas fa-bolt"></i> Pay with Razorpay</button>
                <div id="paypal-btn-monthly" class="paypal-container">Loading PayPal...</div>
            </div>

            <!-- Yearly -->
            <div class="plan-box">
                <div class="plan-header"><span class="plan-title">Yearly (365 Days)</span><span class="plan-price">‚Çπ40 / $0.50</span></div>
                <button class="pay-btn-rzp" onclick="pay.razorpay(40, 'yearly')"><i class="fas fa-bolt"></i> Pay with Razorpay</button>
                <div id="paypal-btn-yearly" class="paypal-container">Loading PayPal...</div>
            </div>
        </div>
    </div>

    <!-- 4. MAIN APP -->
    <div id="main-app">
        <nav>
            <div class="logo">Duty Tracker</div>
            <button id="pwa-install-btn" onclick="pwa.install()"><i class="fas fa-download"></i> Install App</button>
        </nav>

        <div class="app-header">
            <button onclick="cal.move(-1)" style="background:none; border:none; color:white;"><i class="fas fa-chevron-left" style="font-size:28px;"></i></button>
            <h3 id="month-txt" style="font-size:20px;">Loading...</h3>
            <button onclick="cal.move(1)" style="background:none; border:none; color:white;"><i class="fas fa-chevron-right" style="font-size:28px;"></i></button>
        </div>

        <div style="display:grid; grid-template-columns:repeat(7,1fr); text-align:center; font-size:12px; font-weight:bold; margin-bottom:10px; color:#aaa; padding:0 10px;"><div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div></div>
        <div id="calendar-grid" style="padding:0 10px;"></div>

        <div style="position:fixed; bottom:25px; left:0; width:100%; display:flex; justify-content:center; gap:20px;">
            <button onclick="document.getElementById('reports').style.display='flex'" class="m3-btn" style="width:auto; padding:12px 30px;"><i class="fas fa-chart-pie"></i> Reports</button>
            <button onclick="ui.openProfile()" class="m3-btn" style="width:auto; padding:12px 30px;"><i class="fas fa-user"></i> Profile</button>
        </div>
    </div>

    <!-- MODAL -->
    <div id="modal">
        <h3 id="modal-date" style="text-align:center; margin-bottom:20px; color:white;">Date</h3>
        <div class="type-grid">
            <button class="type-btn" onclick="data.set('Present', this)">Present</button>
            <button class="type-btn" onclick="data.set('Leave', this)">Leave</button>
            <button class="type-btn" onclick="data.set('Sick', this)">Sick</button>
            <button class="type-btn" onclick="data.set('Holiday', this)">Holiday</button>
            <button class="type-btn" onclick="data.set('Off', this)">Off</button>
        </div>
        <div style="margin-top:20px; display:flex; gap:15px;">
            <input type="number" id="inp-ot" placeholder="OT (Hrs)" class="settings-input">
            <input type="number" id="inp-late" placeholder="Late (Min)" class="settings-input">
        </div>
        <button class="m3-btn" onclick="data.save()" style="margin-top:20px;">Save Entry</button>
        <button onclick="document.getElementById('modal').style.display='none'" style="width:100%; padding:15px; background:none; border:none; color:#f44336; margin-top:5px; font-weight:bold;">Cancel</button>
    </div>

    <!-- PROFILE & SETTINGS -->
    <div id="settings" class="full-page">
        <div class="fp-head"><i class="fas fa-arrow-left" onclick="this.parentElement.parentElement.style.display='none'" style="font-size:24px;"></i> <h3>Profile & Settings</h3></div>
        <div class="fp-body">
            
            <div class="profile-card">
                <i class="fas fa-user-circle" style="font-size:60px; color:var(--secondary); margin-bottom:15px;"></i>
                <h3 id="prof-id" style="font-size:20px;">...</h3>
                <div style="margin:10px 0;"><span class="sub-badge" id="prof-status">TRIAL</span></div>
                <p id="prof-exp" style="font-size:14px; color:#aaa; margin-bottom:20px;">Expires on: ...</p>
                <button class="m3-btn" style="background:var(--accent); font-size:14px;" onclick="pay.showPaymentScreen(false)">‚ö° Extend Premium</button>
            </div>

            <h4 style="color:var(--primary); margin-bottom:15px;">Preferences</h4>
            <div class="input-group">
                <label class="input-label">Currency</label>
                <select id="set-cur" class="settings-input">
                    <option value="‡ß≥">‡ß≥ (BDT)</option><option value="‚Çπ">‚Çπ (INR)</option><option value="$">$ (USD)</option>
                    <option value="‚Ç¨">‚Ç¨ (Euro)</option><option value="¬£">¬£ (Pound)</option><option value="ÿØ.ÿ•">ÿØ.ÿ• (AED)</option>
                </select>
            </div>
            <div class="input-group">
                <label class="input-label">Daily Salary</label>
                <input type="number" id="set-sal" class="settings-input" placeholder="0">
            </div>
            <div class="input-group">
                <label class="input-label">Overtime Rate (Per Hour)</label>
                <input type="number" id="set-otr" class="settings-input" placeholder="0">
            </div>
            <button class="m3-btn" onclick="settings.save()">Save Settings</button>

            <!-- DONATE & SUPPORT -->
            <div class="donate-section">
                <h4 style="color:white; margin-bottom:10px;">Support Development ‚ù§Ô∏è</h4>
                <p style="font-size:12px; color:#aaa;">If you like this app, support us!</p>
                <div class="donate-badges">
                    <a href="https://buymeacoffee.com/nitaigrp00a" target="_blank"><img src="https://img.shields.io/badge/Buy%20Me%20a%20Coffee-FFDD00?logo=buy-me-a-coffee&logoColor=black&style=for-the-badge" alt="Buy Me A Coffee"></a>
                    <a href="https://ko-fi.com/nitaisarkar" target="_blank"><img src="https://img.shields.io/badge/Ko--fi-Support%20Me-FF5E5B?logo=ko-fi&logoColor=white&style=for-the-badge" alt="Ko-fi"></a>
                    <a href="https://www.patreon.com/cw/NitaiStudio" target="_blank"><img src="https://img.shields.io/badge/Patreon-Support%20Me-F96854?logo=patreon&logoColor=white&style=for-the-badge" alt="Patreon"></a>
                </div>
            </div>

            <h4 style="color:white; margin:30px 0 15px;">Legal & Support</h4>
            <button class="legal-btn" onclick="legal.show('privacy')"><span>Privacy Policy</span> <i class="fas fa-chevron-right"></i></button>
            <button class="legal-btn" onclick="legal.show('refund')"><span>Refund Policy</span> <i class="fas fa-chevron-right"></i></button>
            <button class="legal-btn" onclick="legal.show('terms')"><span>Disclaimer</span> <i class="fas fa-chevron-right"></i></button>
            <button class="legal-btn" onclick="location.href='mailto:nitai.grp00@gmail.com'"><span>Contact Support</span> <i class="fas fa-envelope"></i></button>
            <p style="text-align:center; font-size:12px; color:#555; margin-top:20px;">v2.5.0</p>
        </div>
    </div>

    <!-- REPORTS -->
    <div id="reports" class="full-page">
        <div class="fp-head"><i class="fas fa-arrow-left" onclick="this.parentElement.parentElement.style.display='none'" style="font-size:24px;"></i> <h3>Reports</h3></div>
        <div class="fp-body">
            <div style="display:flex; gap:15px; margin-bottom:20px;">
                <div style="flex:1"><label class="input-label">From</label><input type="date" id="r-start" class="settings-input"></div>
                <div style="flex:1"><label class="input-label">To</label><input type="date" id="r-end" class="settings-input"></div>
            </div>
            <button class="m3-btn" onclick="reports.gen()">Generate Report</button>
            <div id="r-out" style="margin-top:25px;"></div>
        </div>
    </div>

    <!-- LEGAL MODAL -->
    <div id="legal-modal">
        <div class="legal-content">
            <button class="legal-close" onclick="document.getElementById('legal-modal').style.display='none'">&times;</button>
            <h3 id="legal-title">Policy</h3>
            <div id="legal-body" style="font-size:13px; color:#aaa;"></div>
        </div>
    </div>

    <script>
        // DOMAIN SECURITY
        (function() {
            var allowed = "nitaistudio.github.io"; 
            var host = window.location.hostname;
            if (host && host !== allowed && host !== "localhost" && host !== "127.0.0.1") {
                document.body.innerHTML = "<div style='display:flex;height:100vh;justify-content:center;align-items:center;background:#000;color:red;flex-direction:column;text-align:center;'><h1>üö´ Access Denied</h1><p>Code Theft Detected. Domain Mismatch.</p></div>";
                throw new Error("Unauthorized Domain");
            }
        })();

        // FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDf1C_8igKRvV6E3bA2L-zjWabhPb6k25U",
            authDomain: "duty-tracker-5bc76.firebaseapp.com",
            databaseURL: "https://duty-tracker-5bc76-default-rtdb.firebaseio.com",
            projectId: "duty-tracker-5bc76",
            storageBucket: "duty-tracker-5bc76.firebasestorage.app",
            messagingSenderId: "695532299998",
            appId: "1:695532299998:web:f3b02fba3bb087f093c44f"
        };
        try { firebase.initializeApp(firebaseConfig); } catch(e) {}
        const db = firebase.database();
        const RZP_KEY = "rzp_live_RyuF0DQNLGiAH2";

        const s = { uid: null, date: new Date(), data: {}, sub: 0, conf: { cur: '‡ß≥', sal: 0, otr: 0 } };
        let sel = { d: null, t: null };
        let paypalRendered = false;

        window.onload = () => {
            setTimeout(() => {
                document.getElementById('splash').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('splash').style.display = 'none';
                    const id = localStorage.getItem('dt_id');
                    if(id && id !== "null") app.start(id); 
                    else document.getElementById('auth-screen').style.display = 'flex';
                }, 800);
            }, 3000);
        };

        const app = {
            login: () => {
                const code = document.getElementById('country-code').value;
                const num = document.getElementById('auth-phone').value.trim();
                if(num.length > 5) {
                    const fullId = code + num;
                    localStorage.setItem('dt_id', fullId);
                    document.getElementById('auth-screen').style.display = 'none';
                    app.start(fullId);
                } else alert("Invalid Number");
            },
            start: (id) => { 
                s.uid = id;
                db.ref('u/' + s.uid).on('value', snap => {
                    const v = snap.val() || {};
                    s.data = v.att || {};
                    if (!v.subExp) {
                        const trialEnd = Date.now() + (7 * 24 * 60 * 60 * 1000); // 7 Days Free
                        db.ref('u/' + s.uid + '/subExp').set(trialEnd);
                        s.sub = trialEnd;
                    } else { s.sub = v.subExp; }
                    
                    if(v.conf) {
                        s.conf = { ...s.conf, ...v.conf };
                        document.getElementById('set-cur').value = s.conf.cur || '‡ß≥';
                        document.getElementById('set-sal').value = s.conf.sal || '';
                        document.getElementById('set-otr').value = s.conf.otr || '';
                    }
                    app.checkSub();
                    cal.render(); // Render once data is ready
                });
            },
            checkSub: () => {
                const now = Date.now();
                if(now > s.sub) {
                    pay.showPaymentScreen(true);
                } else {
                    document.getElementById('payment-screen').style.display = 'none';
                    document.getElementById('main-app').style.display = 'block';
                }
            }
        };

        const pay = {
            showPaymentScreen: (isLocked) => {
                document.getElementById('payment-screen').style.display = 'flex';
                document.getElementById('pay-close-btn').style.display = isLocked ? 'none' : 'flex';
                if(isLocked) document.getElementById('main-app').style.display = 'none';
                setTimeout(() => pay.initPayPal(), 100); 
            },
            razorpay: (amt, plan) => {
                const options = {
                    "key": RZP_KEY, "amount": amt * 100, "currency": "INR",
                    "name": "Duty Tracker Pro", "description": plan,
                    "handler": function (response) { pay.success(plan, response.razorpay_payment_id); },
                    "prefill": { "contact": s.uid }, "theme": { "color": "#6C63FF" }
                };
                const rzp1 = new Razorpay(options); rzp1.open();
            },
            initPayPal: () => {
                if(paypalRendered) return;
                
                document.getElementById('paypal-btn-monthly').innerHTML = "";
                document.getElementById('paypal-btn-yearly').innerHTML = "";

                if (typeof paypal !== 'undefined') {
                    const style = { layout: 'horizontal', color: 'gold', height: 40, label: 'pay', tagline: false };
                    paypal.Buttons({ style: style, createOrder: (d, a) => a.order.create({ purchase_units: [{ amount: { value: '0.10' } }] }), onApprove: (d, a) => a.order.capture().then(det => pay.success('monthly', det.id)) }).render('#paypal-btn-monthly');
                    paypal.Buttons({ style: style, createOrder: (d, a) => a.order.create({ purchase_units: [{ amount: { value: '0.50' } }] }), onApprove: (d, a) => a.order.capture().then(det => pay.success('yearly', det.id)) }).render('#paypal-btn-yearly');
                    paypalRendered = true;
                }
            },
            success: (plan, pid) => {
                const now = Date.now();
                let add = (plan === 'yearly') ? 31536000000 : 2592000000;
                let newExp = (now > s.sub ? now : s.sub) + add;
                db.ref('u/' + s.uid + '/subExp').set(newExp).then(() => {
                    alert("Payment Successful!"); location.reload();
                });
            }
        };

        const legal = {
            show: (type) => {
                const titleMap = { 'privacy': 'Privacy Policy', 'refund': 'Refund Policy', 'terms': 'Disclaimer' };
                const textMap = {
                    'privacy': 'Duty Tracker Pro respects your privacy. We collect your mobile number solely for account authentication. Your data is stored securely on Google Firebase and never shared. Payments are processed via Razorpay/PayPal.',
                    'refund': 'All payments are final. However, if you face technical issues preventing access to premium features, please contact support within 24 hours for assistance.',
                    'terms': 'This app is provided "as is". Duty Tracker Pro is not responsible for any financial losses due to calculation errors. Users are advised to verify salary calculations manually.'
                };
                document.getElementById('legal-title').innerText = titleMap[type];
                document.getElementById('legal-body').innerText = textMap[type];
                document.getElementById('legal-modal').style.display = 'flex';
            }
        };

        const ui = {
            openProfile: () => {
                document.getElementById('settings').style.display = 'flex';
                document.getElementById('prof-id').innerText = s.uid;
                const expDate = new Date(s.sub);
                const daysLeft = Math.ceil((s.sub - Date.now()) / (1000 * 60 * 60 * 24));
                document.getElementById('prof-exp').innerText = `Valid till: ${expDate.toDateString()}`;
                
                if(daysLeft > 7) {
                    document.getElementById('prof-status').innerText = "PREMIUM";
                    document.getElementById('prof-status').style.background = "#4caf50";
                } else {
                    document.getElementById('prof-status').innerText = `${daysLeft} DAYS LEFT`;
                    document.getElementById('prof-status').style.background = "#ff9800";
                }
            }
        };

        const cal = {
            getIso: (y, m, d) => `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`,
            render: () => {
                const y=s.date.getFullYear(), m=s.date.getMonth();
                document.getElementById('month-txt').innerText = new Date(y, m).toLocaleString('default', { month: 'long', year: 'numeric' });
                const grid = document.getElementById('calendar-grid'); grid.innerHTML='';
                const fDay = new Date(y,m,1).getDay(), lDate = new Date(y,m+1,0).getDate();
                for(let i=0; i<fDay; i++) grid.innerHTML += `<div></div>`;
                for(let i=1; i<=lDate; i++) {
                    const iso = cal.getIso(y, m, i);
                    const ent = s.data[iso];
                    const el = document.createElement('div'); el.className = 'day-cell';
                    if(iso === new Date().toISOString().split('T')[0]) el.style.border = '2px solid var(--secondary)';
                    if(ent) el.classList.add('bg-'+ent.t);
                    
                    el.innerHTML = `<span style="font-weight:bold; color:white;">${i}</span>`;
                    if(ent) {
                        el.innerHTML += `<div style="font-size:9px; margin-top:2px; opacity:0.9">${ent.t}</div>`;
                        if(ent.ot) el.innerHTML += `<div style="font-size:9px; color:#ffff00; font-weight:bold;">OT: ${ent.ot}</div>`;
                    }
                    el.onclick=()=> {
                        sel.d = iso;
                        document.getElementById('modal-date').innerText = new Date(iso).toDateString();
                        document.getElementById('modal').style.display='block';
                        document.querySelectorAll('.type-btn').forEach(b=>b.classList.remove('active'));
                        if(ent) {
                            document.getElementById('inp-ot').value = ent.ot || '';
                            document.getElementById('inp-late').value = ent.lt || '';
                        }
                    };
                    grid.appendChild(el);
                }
            },
            move: (v) => { s.date.setMonth(s.date.getMonth()+v); cal.render(); }
        };

        const data = {
            set: (t, btn) => { sel.t = t; document.querySelectorAll('.type-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); },
            save: () => {
                if(!sel.t && !document.getElementById('inp-ot').value) return alert("Select Type");
                const p = { t: sel.t || 'Present', ot: document.getElementById('inp-ot').value, lt: document.getElementById('inp-late').value };
                db.ref(`u/${s.uid}/att/${sel.d}`).set(p).then(() => {
                    alert("Saved!");
                    document.getElementById('modal').style.display='none';
                });
            }
        };

        const settings = {
            save: () => {
                s.conf.cur = document.getElementById('set-cur').value;
                s.conf.sal = parseFloat(document.getElementById('set-sal').value) || 0;
                s.conf.otr = parseFloat(document.getElementById('set-ot-rate').value || document.getElementById('set-otr').value) || 0;
                
                db.ref(`u/${s.uid}/conf`).set(s.conf).then(()=>alert("Settings Saved"));
            }
        };

        const reports = {
            gen: () => {
                const sD=document.getElementById('r-start').value, eD=document.getElementById('r-end').value;
                if(!sD) return alert("Select Dates");
                let pres=0, otHrs=0, tot=0;
                const start=new Date(sD), end=new Date(eD);
                for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)) {
                    const iso = d.toISOString().split('T')[0]; tot++;
                    const e = s.data[iso];
                    if(e) { if(['Present','Holiday'].includes(e.t)) pres++; otHrs += parseFloat(e.ot||0); }
                }
                const earn = (pres * s.conf.sal) + (otHrs * s.conf.otr);
                document.getElementById('r-out').innerHTML = `
                    <div style="background:var(--surface); padding:20px; border-radius:16px; border:1px solid var(--border);">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><span>Total Days</span> <b>${tot}</b></div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px; color:#4caf50;"><span>Paid Days</span> <b>${pres}</b></div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px; color:#ff9800;"><span>Overtime</span> <b>${otHrs} Hrs</b></div>
                        <hr style="border-color:var(--border); margin:15px 0;">
                        <div style="text-align:center; font-size:22px; font-weight:bold; color:var(--secondary);">
                            Total: ${s.conf.cur} ${earn}
                        </div>
                    </div>
                `;
            }
        };

        // PWA Install Logic
        let deferredPrompt;
        const pwaBtn = document.getElementById('pwa-install-btn');
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); deferredPrompt = e; pwaBtn.style.display = 'flex';
        });
        const pwa = {
            install: () => {
                if(deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((c) => { if(c.outcome==='accepted') pwaBtn.style.display='none'; deferredPrompt = null; });
                }
            }
        };
        if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');

    </script>
</body>
</html>