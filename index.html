<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#6200ea">
    <title>Duty Tracker Pro</title>

    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        /* --- ANDROID MATERIAL THEME --- */
        :root {
            --primary: #6200ea;
            --primary-dark: #3700b3;
            --bg: #f8f9fa;
            --surface: #ffffff;
            --text: #202124;
            
            /* Full Colors */
            --c-present: #4caf50; --bg-present: #4caf50; --txt-present: #fff;
            --c-leave: #f44336;   --bg-leave: #f44336;   --txt-leave: #fff;
            --c-sick: #ff9800;    --bg-sick: #ff9800;    --txt-sick: #fff;
            --c-holiday: #9c27b0; --bg-holiday: #9c27b0; --txt-holiday: #fff;
            --c-off: #607d8b;     --bg-off: #eceff1;     --txt-off: #546e7a;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* SPLASH */
        #splash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; transition: opacity 0.5s; }
        .loader { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; margin-top: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* HEADER */
        header { background: var(--primary); color: white; padding: 15px; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; box-shadow: 0 4px 10px rgba(98, 0, 234, 0.3); z-index: 10; }
        .app-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .app-title { font-size: 20px; font-weight: 700; letter-spacing: 0.5px; }
        
        .month-nav { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.15); padding: 8px 15px; border-radius: 12px; }
        .month-title { font-size: 16px; font-weight: 500; }
        .nav-btn { background: none; border: none; color: white; font-weight: bold; font-size: 14px; padding: 5px 10px; cursor: pointer; }

        .week-days { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 12px; margin-top: 15px; opacity: 0.9; font-weight: bold; }

        /* CALENDAR */
        #calendar-grid { flex: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(7, 1fr); grid-auto-rows: minmax(90px, 1fr); gap: 8px; padding-bottom: 80px; }
        
        .day-cell { 
            background: var(--surface); border-radius: 12px; padding: 6px; 
            position: relative; display: flex; flex-direction: column; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.1s; border: 1px solid transparent;
        }
        .day-cell:active { transform: scale(0.96); }
        .day-cell.today { border: 2px solid var(--primary); background: #f0ebfa; }
        .day-num { font-size: 14px; font-weight: 700; color: #444; margin-bottom: 2px; }

        /* FULL COLOR STYLES */
        .bg-Present { background: var(--bg-present) !important; color: white !important; }
        .bg-Leave { background: var(--bg-leave) !important; color: white !important; }
        .bg-Sick { background: var(--bg-sick) !important; color: white !important; }
        .bg-Holiday { background: var(--bg-holiday) !important; color: white !important; }
        .bg-Off { background: var(--bg-off); color: var(--txt-off); }

        .bg-Present .day-num, .bg-Leave .day-num, .bg-Sick .day-num, .bg-Holiday .day-num { color: white; opacity: 0.9; }

        /* BADGES (OT / Late) */
        .info-badges { margin-top: auto; display: flex; flex-wrap: wrap; gap: 2px; }
        .badge { font-size: 9px; padding: 2px 5px; border-radius: 4px; font-weight: bold; }
        .b-ot { background: rgba(0,0,0,0.6); color: white; border: 1px solid rgba(255,255,255,0.3); }
        .b-late { background: #fff; color: #d32f2f; }

        /* MODAL (Bottom Sheet Style) */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; display: none; justify-content: center; align-items: flex-end; }
        .modal.show { display: flex; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .sheet { background: white; width: 100%; max-width: 500px; border-radius: 25px 25px 0 0; padding: 25px; padding-bottom: 40px; }
        .sheet-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .sheet-title { font-size: 20px; font-weight: bold; color: var(--primary); }

        .type-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .type-btn { padding: 12px; border: 1px solid #eee; border-radius: 10px; background: white; font-weight: 600; font-size: 13px; color: #555; }
        .type-btn.active { color: white; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        .type-btn[data-t="Present"].active { background: var(--c-present); }
        .type-btn[data-t="Leave"].active { background: var(--c-leave); }
        .type-btn[data-t="Sick"].active { background: var(--c-sick); }
        .type-btn[data-t="Holiday"].active { background: var(--c-holiday); }
        .type-btn[data-t="Off"].active { background: var(--c-off); color: white; }

        .input-row { display: flex; gap: 15px; margin-bottom: 20px; }
        .input-box { flex: 1; }
        .input-box label { font-size: 12px; color: #666; display: block; margin-bottom: 5px; }
        .input-box input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; outline: none; }
        .input-box input:focus { border-color: var(--primary); }

        .action-btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; margin-bottom: 10px; cursor: pointer; }
        .save-btn { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(98,0,234,0.3); }
        .clear-btn { background: #ffebee; color: #d32f2f; }

        /* AUTH SCREEN */
        #auth-screen { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; flex-direction: column; }
        .auth-box { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 100%; max-width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .auth-inp { width: 100%; padding: 15px; border: 1px solid #ddd; border-radius: 10px; margin: 20px 0; text-align: center; font-size: 18px; }

        /* SETTINGS & REPORT PAGE */
        .full-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8f9fa; z-index: 200; transform: translateX(100%); transition: 0.3s; display: flex; flex-direction: column; }
        .full-page.open { transform: translateX(0); }
        .fp-header { background: white; padding: 15px; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .fp-content { padding: 20px; overflow-y: auto; }
        .setting-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        
        /* TOAST MSG */
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #323232; color: white; padding: 12px 24px; border-radius: 50px; font-size: 14px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 500; }
        #toast.show { opacity: 1; bottom: 50px; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- SPLASH -->
    <div id="splash">
        <span class="material-icons" style="font-size:70px;">assignment_ind</span>
        <h1 style="margin-top:10px; font-size:24px;">Duty Tracker</h1>
        <div class="loader"></div>
    </div>

    <!-- AUTH -->
    <div id="auth-screen" class="hidden">
        <div class="auth-box">
            <h2 style="color:var(--primary)">Welcome</h2>
            <p style="color:#666; margin-top:5px;">Enter your ID to restore data</p>
            <input type="text" id="auth-id" class="auth-inp" placeholder="User ID">
            <button class="action-btn save-btn" onclick="app.login()">RESTORE</button>
            <button style="background:none; border:none; color:var(--primary); margin-top:10px;" onclick="app.createId()">Create New ID</button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="hidden">
        <header>
            <div class="app-bar">
                <span class="material-icons" onclick="ui.togglePage('settings', true)">settings</span>
                <span class="app-title">Duty Tracker</span>
                <span class="material-icons" onclick="ui.togglePage('reports', true)">assessment</span>
            </div>
            <div class="month-nav">
                <button class="nav-btn" onclick="cal.move(-1)">PREV</button>
                <span class="month-title" id="month-txt">Loading...</span>
                <button class="nav-btn" onclick="cal.move(1)">NEXT</button>
            </div>
            <div class="week-days" id="week-header"></div>
        </header>

        <div id="calendar-grid"></div>
    </div>

    <!-- MODAL -->
    <div id="modal" class="modal" onclick="if(event.target===this) ui.closeModal()">
        <div class="sheet">
            <div class="sheet-head">
                <span class="sheet-title" id="modal-date">Date</span>
                <span class="material-icons" onclick="ui.closeModal()" style="color:#999">close</span>
            </div>
            <div class="type-grid">
                <button class="type-btn" data-t="Present" onclick="data.setType('Present', this)">Present</button>
                <button class="type-btn" data-t="Leave" onclick="data.setType('Leave', this)">Leave</button>
                <button class="type-btn" data-t="Sick" onclick="data.setType('Sick', this)">Sick</button>
                <button class="type-btn" data-t="Holiday" onclick="data.setType('Holiday', this)">Holiday</button>
                <button class="type-btn" data-t="Off" onclick="data.setType('Off', this)">Off</button>
            </div>
            <div class="input-row">
                <div class="input-box">
                    <label>Overtime (Hours)</label>
                    <input type="number" id="inp-ot" placeholder="0">
                </div>
                <div class="input-box">
                    <label>Late (Minutes)</label>
                    <input type="number" id="inp-late" placeholder="0">
                </div>
            </div>
            <button class="action-btn save-btn" onclick="data.save()">SAVE ENTRY</button>
            <button class="action-btn clear-btn" onclick="data.clear()">CLEAR DATA</button>
        </div>
    </div>

    <!-- SETTINGS -->
    <div id="settings" class="full-page">
        <div class="fp-header">
            <span class="material-icons" onclick="ui.togglePage('settings', false)">arrow_back</span>
            <h3>Settings</h3>
        </div>
        <div class="fp-content">
            <div class="setting-card">
                <label style="color:var(--primary); font-weight:bold; display:block; margin-bottom:5px;">YOUR RECOVERY ID</label>
                <input type="text" id="uid-disp" readonly style="width:100%; padding:10px; background:#f0f0f0; border:none; border-radius:5px;">
            </div>
            <div class="setting-card">
                <label>Week Start Day</label>
                <select id="set-week" style="width:100%; padding:10px; margin-top:5px; border:1px solid #ddd; border-radius:5px;" onchange="settings.save()">
                    <option value="0">Sunday</option>
                    <option value="1">Monday</option>
                </select>
            </div>
            <div class="setting-card">
                <label>Weekly Off Day</label>
                <select id="set-off" style="width:100%; padding:10px; margin-top:5px; border:1px solid #ddd; border-radius:5px;" onchange="settings.save()">
                    <option value="0">Sunday</option>
                    <option value="6">Saturday</option>
                    <option value="5">Friday</option>
                </select>
            </div>
        </div>
    </div>

    <!-- REPORTS -->
    <div id="reports" class="full-page">
        <div class="fp-header">
            <span class="material-icons" onclick="ui.togglePage('reports', false)">arrow_back</span>
            <h3>Reports</h3>
        </div>
        <div class="fp-content">
            <div class="setting-card" style="display:flex; gap:10px;">
                <input type="date" id="r-start" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:5px;">
                <input type="date" id="r-end" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:5px;">
            </div>
            <button class="action-btn save-btn" onclick="reports.gen()">CALCULATE</button>
            <div id="r-out" style="margin-top:20px;"></div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast">Data Saved!</div>

    <script>
        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDf1C_8igKRvV6E3bA2L-zjWabhPb6k25U",
            authDomain: "duty-tracker-5bc76.firebaseapp.com",
            databaseURL: "https://duty-tracker-5bc76-default-rtdb.firebaseio.com",
            projectId: "duty-tracker-5bc76",
            storageBucket: "duty-tracker-5bc76.firebasestorage.app",
            messagingSenderId: "695532299998",
            appId: "1:695532299998:web:f3b02fba3bb087f093c44f"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // STATE
        const s = { uid: null, date: new Date(), data: {}, conf: { ws: 0, wo: 0 } }; // ws: weekStart, wo: weeklyOff
        let sel = { d: null, t: null };

        // INIT
        window.onload = () => {
            setTimeout(() => {
                document.getElementById('splash').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('splash').classList.add('hidden');
                    const id = localStorage.getItem('dt_id');
                    if(id) app.start(id);
                    else document.getElementById('auth-screen').classList.remove('hidden');
                }, 500);
            }, 1500);
        };

        const app = {
            createId: () => {
                const id = 'u_' + Date.now().toString(36);
                localStorage.setItem('dt_id', id);
                app.start(id);
            },
            login: () => {
                const id = document.getElementById('auth-id').value.trim();
                if(id) { localStorage.setItem('dt_id', id); app.start(id); }
            },
            start: (id) => {
                s.uid = id;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('uid-disp').value = id;

                // Listen to DB
                db.ref('u/' + id).on('value', snap => {
                    const v = snap.val();
                    if(v) {
                        s.data = v.att || {};
                        if(v.conf) s.conf = v.conf;
                        document.getElementById('set-week').value = s.conf.ws;
                        document.getElementById('set-off').value = s.conf.wo;
                    }
                    cal.render();
                });
            }
        };

        const cal = {
            render: () => {
                const y = s.date.getFullYear(), m = s.date.getMonth();
                const mN = ["January","February","March","April","May","June","July","August","September","October","November","December"];
                document.getElementById('month-txt').innerText = `${mN[m]} ${y}`;

                const days = s.conf.ws === 1 ? ['M','T','W','T','F','S','S'] : ['S','M','T','W','T','F','S'];
                document.getElementById('week-header').innerHTML = days.map(d => `<div>${d}</div>`).join('');

                const grid = document.getElementById('calendar-grid');
                grid.innerHTML = '';

                const fDay = new Date(y, m, 1).getDay();
                const lDate = new Date(y, m+1, 0).getDate();
                const today = new Date().toISOString().split('T')[0];

                let pad = fDay - s.conf.ws;
                if(pad < 0) pad += 7;

                for(let i=0; i<pad; i++) grid.innerHTML += `<div></div>`;

                for(let i=1; i<=lDate; i++) {
                    const mm = String(m+1).padStart(2,'0'), dd = String(i).padStart(2,'0');
                    const iso = `${y}-${mm}-${dd}`;
                    const dObj = new Date(y, m, i);
                    const ent = s.data[iso];

                    const el = document.createElement('div');
                    el.className = 'day-cell';
                    if(iso === today) el.classList.add('today');

                    // FULL COLOR LOGIC
                    if(ent) el.classList.add('bg-' + ent.t);
                    else if(dObj.getDay() === parseInt(s.conf.wo)) el.classList.add('bg-Off');

                    let h = `<span class="day-num">${i}</span>`;
                    if(ent) {
                        h += `<div class="info-badges">`;
                        if(ent.ot > 0) h += `<span class="badge b-ot">OT:${ent.ot}</span>`;
                        if(ent.lt > 0) h += `<span class="badge b-late">L:${ent.lt}</span>`;
                        h += `</div>`;
                    }
                    el.innerHTML = h;
                    el.onclick = () => ui.open(iso, ent);
                    grid.appendChild(el);
                }
            },
            move: (v) => { s.date.setMonth(s.date.getMonth() + v); cal.render(); }
        };

        const data = {
            setType: (t, btn) => {
                sel.t = t;
                document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            },
            save: () => {
                if(!sel.t) return alert("Select type");
                const p = {
                    t: sel.t,
                    ot: parseFloat(document.getElementById('inp-ot').value) || 0,
                    lt: parseInt(document.getElementById('inp-late').value) || 0
                };
                db.ref(`u/${s.uid}/att/${sel.d}`).set(p).then(() => ui.toast("Saved!"));
                ui.closeModal();
            },
            clear: () => {
                db.ref(`u/${s.uid}/att/${sel.d}`).remove().then(() => ui.toast("Deleted"));
                ui.closeModal();
            }
        };

        const settings = {
            save: () => {
                s.conf.ws = parseInt(document.getElementById('set-week').value);
                s.conf.wo = parseInt(document.getElementById('set-off').value);
                db.ref(`u/${s.uid}/conf`).set(s.conf).then(() => ui.toast("Settings Saved"));
            }
        };

        const reports = {
            gen: () => {
                const sD = document.getElementById('r-start').value;
                const eD = document.getElementById('r-end').value;
                if(!sD || !eD) return alert("Select dates");
                
                let tot=0, pres=0, leave=0, hol=0, ot=0;
                const start = new Date(sD), end = new Date(eD);

                for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)) {
                    const iso = d.toISOString().split('T')[0];
                    tot++;
                    const e = s.data[iso];
                    if(e) {
                        if(e.t==='Present') pres++;
                        if(['Leave','Sick'].includes(e.t)) leave++;
                        if(e.t==='Holiday') hol++;
                        ot += (e.ot || 0);
                    }
                }
                
                const box = (lbl, val, col) => `
                    <div style="display:flex; justify-content:space-between; padding:15px; background:white; margin-bottom:8px; border-radius:8px; border-left:5px solid ${col}; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                        <span>${lbl}</span> <span style="font-weight:bold">${val}</span>
                    </div>`;

                document.getElementById('r-out').innerHTML = 
                    box('Total Days', tot, '#333') +
                    box('Present', pres, '#4caf50') +
                    box('Leave/Sick', leave, '#f44336') +
                    box('Holiday', hol, '#9c27b0') +
                    box('Overtime (Hrs)', ot, '#ff9800');
            }
        };

        const ui = {
            open: (d, e) => {
                sel.d = d; sel.t = null;
                document.getElementById('modal-date').innerText = d;
                document.getElementById('modal').classList.add('show');
                document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('inp-ot').value = '';
                document.getElementById('inp-late').value = '';
                if(e) {
                    sel.t = e.t;
                    const btn = document.querySelector(`.type-btn[data-t="${e.t}"]`);
                    if(btn) btn.classList.add('active');
                    document.getElementById('inp-ot').value = e.ot || '';
                    document.getElementById('inp-late').value = e.lt || '';
                }
            },
            closeModal: () => document.getElementById('modal').classList.remove('show'),
            togglePage: (id, o) => {
                const el = document.getElementById(id);
                if(o) el.classList.add('open'); else el.classList.remove('open');
                if(id==='reports' && o) {
                    const now=new Date(), y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,'0');
                    document.getElementById('r-start').value = `${y}-${m}-01`;
                    document.getElementById('r-end').value = now.toISOString().split('T')[0];
                }
            },
            toast: (msg) => {
                const t = document.getElementById('toast');
                t.innerText = msg; t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 2000);
            }
        };
        
        // SW REG
        if('serviceWorker' in navigator){
            navigator.serviceWorker.register('./sw.js').then(()=>console.log("SW OK"));
        }
    </script>
</body>
</html>