<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Duty Tracker Pro</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Razorpay SDK -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    
    <!-- PayPal SDK -->
    <script src="https://www.paypal.com/sdk/js?client-id=AfOzNhmiQjamiR4usKOUs_hullqnPZaXSTks076L48mXJJaMAn3Rblux_KJsP6_D20xX3s37hnns4p2R&currency=USD&disable-funding=credit,card"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #6C63FF;
            --secondary: #00F0FF;
            --accent: #FF0055;
            --dark-bg: #050505;
            --glass: rgba(255, 255, 255, 0.08);
            --border: rgba(255, 255, 255, 0.15);
            --gradient: linear-gradient(135deg, #6C63FF, #00F0FF);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; }
        
        body { 
            background-color: var(--dark-bg);
            background-image: radial-gradient(circle at 10% 20%, rgba(108, 99, 255, 0.15) 0%, transparent 20%),
                              radial-gradient(circle at 90% 80%, rgba(0, 240, 255, 0.15) 0%, transparent 20%);
            color: #ffffff; overflow-x: hidden; min-height: 100vh; display: flex; flex-direction: column;
        }

        /* --- SPLASH SCREEN (PERFECT CENTER) --- */
        #splash { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            z-index: 999999; 
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center; 
            transition: opacity 0.8s ease-out;
        }
        
        .splash-logo-icon {
            font-size: 80px; 
            background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 20px; animation: pulse 2s infinite;
            filter: drop-shadow(0 0 15px rgba(108, 99, 255, 0.6));
            display: block;
        }

        .splash-title { 
            font-size: 28px; font-weight: 800; letter-spacing: 1px; color: white; margin-bottom: 30px; 
            display: block;
        }

        .loader { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--secondary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
        
        .splash-footer { position: absolute; bottom: 30px; width: 100%; text-align: center; animation: fadeInUp 1s ease-out 0.5s backwards; }
        .dev-text { font-size: 14px; color: #ccc; margin-bottom: 5px; }
        .made-in { font-size: 12px; color: #888; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .made-in img { width: 22px; border-radius: 2px; }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- MAIN UI --- */
        nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 5%; position: sticky; top: 0; z-index: 1000;
            background: rgba(5, 5, 5, 0.9); backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border);
        }
        .logo { font-size: 20px; font-weight: 800; background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        #pwa-install-btn {
            background: var(--gradient); border: none; color: white;
            padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;
            display: none; animation: pulse 2s infinite;
        }

        /* --- PAYMENT SCREEN --- */
        #payment-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); backdrop-filter: blur(20px);
            z-index: 99999; display: none; flex-direction: column; 
            align-items: center; justify-content: center; padding: 20px; overflow-y: auto;
        }
        .lock-card {
            background: #111; padding: 20px; border-radius: 20px;
            border: 1px solid var(--accent); box-shadow: 0 0 40px rgba(255, 0, 85, 0.3);
            max-width: 380px; width: 100%; margin-top: 50px; position: relative;
        }
        #pay-close-btn {
            position: absolute; top: 10px; right: 10px;
            background: rgba(255,255,255,0.1); border: none; color: white;
            width: 30px; height: 30px; border-radius: 50%; cursor: pointer;
            display: none; align-items: center; justify-content: center; z-index: 20;
        }
        .plan-box {
            background: rgba(255,255,255,0.05); border: 1px solid var(--border);
            border-radius: 12px; padding: 15px; margin-bottom: 15px;
        }
        .plan-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px;
        }
        .plan-title { font-weight: bold; color: white; font-size: 16px; }
        .plan-price { color: var(--secondary); font-weight: 800; }
        
        .pay-btn-rzp {
            width: 100%; padding: 12px; background: #3399cc; color: white; 
            border: none; border-radius: 5px; font-weight: bold; cursor: pointer;
            margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        
        .paypal-container { width: 100%; margin-top: 10px; min-height: 50px; position: relative; z-index: 10; clear: both; }

        /* LEGAL BUTTONS */
        .legal-btn { width: 100%; padding: 12px; text-align: left; background: rgba(255,255,255,0.05); border: 1px solid var(--border); margin-bottom: 8px; color: #ccc; border-radius: 8px; display: flex; justify-content: space-between; cursor: pointer; }

        /* LEGAL MODAL */
        #legal-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); backdrop-filter: blur(5px); z-index: 4000; display: none; justify-content: center; align-items: center; padding: 20px; }
        .legal-content { background: #151515; width: 100%; max-width: 500px; border-radius: 15px; border: 1px solid var(--border); max-height: 80vh; overflow-y: auto; padding: 25px; position: relative; color: #ccc; line-height: 1.6; }
        .legal-close { position: absolute; top: 15px; right: 15px; background: none; border: none; color: white; font-size: 20px; cursor: pointer; }

        /* AUTH & OTHERS */
        .auth-box {
            margin: auto; padding: 40px 30px; max-width: 350px; width: 90%;
            background: var(--glass); border-radius: 20px; text-align: center;
            border: 1px solid var(--border); box-shadow: 0 0 30px rgba(108, 99, 255, 0.2);
        }
        .auth-inp { width: 100%; padding: 15px; margin: 20px 0; border-radius: 12px; border: 1px solid #333; background: #000; color: white; text-align: center; font-size: 18px; }
        .action-btn { width: 100%; padding: 14px; border-radius: 12px; border: none; background: var(--gradient); color: white; font-weight: bold; cursor: pointer; font-size: 16px; }

        .app-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        #calendar-grid { padding: 10px; display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .day-cell { height: 85px; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 6px; position: relative; border: 1px solid transparent; transition: 0.2s; }
        .bg-Present { background: #4caf50 !important; color: white; }
        .bg-Leave { background: #f44336 !important; color: white; }
        .bg-Sick { background: #ff9800 !important; color: white; }
        .bg-Holiday { background: #9c27b0 !important; color: white; }
        .bg-Off { background: #607d8b !important; color: white; }

        .full-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark-bg); z-index: 3000; display: none; flex-direction: column; overflow-y: auto; }
        .fp-head { padding: 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 15px; background: rgba(0,0,0,0.8); }
        .fp-body { padding: 20px; }
        .profile-card { background: linear-gradient(135deg, rgba(108, 99, 255, 0.2), rgba(0, 240, 255, 0.2)); padding: 20px; border-radius: 15px; border: 1px solid var(--border); margin-bottom: 20px; text-align: center; }
        .sub-badge { background: var(--accent); color: white; padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: bold; text-transform: uppercase; }

        #modal { position: fixed; bottom: 0; width: 100%; background: #111; padding: 25px; border-radius: 25px 25px 0 0; display: none; z-index: 2000; border-top: 1px solid var(--border); }
        .type-btn { padding: 12px; margin: 5px; background: #222; color: white; border: 1px solid #333; border-radius: 8px; width: 30%; }
        .type-btn.active { border-color: var(--secondary); background: rgba(0, 240, 255, 0.1); }

        #main-app, #auth-screen { display: none; }
    </style>
</head>
<body>

    <!-- 1. SPLASH SCREEN -->
    <div id="splash">
        <div class="splash-content">
            <span class="material-icons splash-logo-icon">assignment_ind</span>
            <div class="splash-title">Duty Tracker Pro</div>
            <div class="loader"></div>
        </div>
        <div class="splash-footer">
            <div class="dev-text">Developer By <b>Nitai Studio</b></div>
            <div class="made-in">Made in India <img src="https://flagcdn.com/w40/in.png" alt="India Flag"></div>
        </div>
    </div>

    <!-- 2. AUTH SCREEN -->
    <div id="auth-screen" style="display:flex; height:100vh; align-items:center; justify-content:center;">
        <div class="auth-box">
            <i class="fas fa-fingerprint" style="font-size:50px; color:var(--primary); margin-bottom:20px;"></i>
            <h2 style="margin-bottom:10px;">Login</h2>
            <p style="color:#aaa; font-size:12px; margin-bottom:20px;">Enter Mobile Number for Sync & Trial</p>
            <input type="number" id="auth-phone" class="auth-inp" placeholder="Mobile Number">
            <button class="action-btn" onclick="app.login()">Get Started</button>
        </div>
    </div>

    <!-- 3. PAYMENT SCREEN (FIXED PAYPAL) -->
    <div id="payment-screen">
        <div class="lock-card">
            <button id="pay-close-btn" onclick="document.getElementById('payment-screen').style.display='none'"><i class="fas fa-times"></i></button>
            
            <i class="fas fa-crown" style="font-size:40px; color:var(--accent); margin-bottom:15px; display:block; text-align:center;"></i>
            <h2 style="margin-bottom:10px; color:white; text-align:center;">Premium Access</h2>
            <p style="color:#aaa; font-size:13px; margin-bottom:20px; text-align:center;">Secure your data & enjoy ad-free experience.</p>
            
            <!-- Monthly -->
            <div class="plan-box">
                <div class="plan-header"><span class="plan-title">Monthly (30 Days)</span><span class="plan-price">â‚¹5 / $0.10</span></div>
                <button class="pay-btn-rzp" onclick="pay.razorpay(5, 'monthly')"><i class="fas fa-bolt"></i> Pay with Razorpay</button>
                <div id="paypal-btn-monthly" class="paypal-container">Loading PayPal...</div>
            </div>

            <!-- Yearly -->
            <div class="plan-box">
                <div class="plan-header"><span class="plan-title">Yearly (365 Days)</span><span class="plan-price">â‚¹40 / $0.50</span></div>
                <button class="pay-btn-rzp" onclick="pay.razorpay(40, 'yearly')"><i class="fas fa-bolt"></i> Pay with Razorpay</button>
                <div id="paypal-btn-yearly" class="paypal-container">Loading PayPal...</div>
            </div>
        </div>
    </div>

    <!-- 4. MAIN APP -->
    <div id="main-app">
        <nav>
            <div class="logo">Duty Tracker</div>
            <button id="pwa-install-btn" onclick="pwa.install()"><i class="fas fa-download"></i> Install</button>
        </nav>

        <div class="app-header">
            <button onclick="cal.move(-1)" style="background:none; border:none; color:white;"><i class="fas fa-chevron-left"></i></button>
            <h3 id="month-txt">Loading...</h3>
            <button onclick="cal.move(1)" style="background:none; border:none; color:white;"><i class="fas fa-chevron-right"></i></button>
        </div>

        <div style="display:grid; grid-template-columns:repeat(7,1fr); text-align:center; font-size:12px; font-weight:bold; margin-bottom:10px; color:#aaa;"><div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div></div>
        <div id="calendar-grid"></div>

        <div style="position:fixed; bottom:20px; left:0; width:100%; display:flex; justify-content:center; gap:15px;">
            <button onclick="document.getElementById('reports').style.display='flex'" class="action-btn" style="width:auto; padding:10px 20px; backdrop-filter:blur(10px); background:rgba(255,255,255,0.1); border:1px solid var(--border);"><i class="fas fa-chart-pie"></i> Reports</button>
            <button onclick="ui.openProfile()" class="action-btn" style="width:auto; padding:10px 20px; backdrop-filter:blur(10px); background:rgba(255,255,255,0.1); border:1px solid var(--border);"><i class="fas fa-user"></i> Profile</button>
        </div>
    </div>

    <!-- MODAL -->
    <div id="modal">
        <h3 id="modal-date" style="text-align:center; margin-bottom:15px; color:white;">Date</h3>
        <div style="display:flex; flex-wrap:wrap; justify-content:center;">
            <button class="type-btn" onclick="data.set('Present', this)">Present</button>
            <button class="type-btn" onclick="data.set('Leave', this)">Leave</button>
            <button class="type-btn" onclick="data.set('Sick', this)">Sick</button>
            <button class="type-btn" onclick="data.set('Holiday', this)">Holiday</button>
            <button class="type-btn" onclick="data.set('Off', this)">Off</button>
        </div>
        <div style="margin-top:15px; display:flex; gap:10px;">
            <input type="number" id="inp-ot" placeholder="OT Hrs" style="width:50%; padding:12px; background:#222; border:1px solid #333; color:white; border-radius:8px;">
            <input type="number" id="inp-late" placeholder="Late Min" style="width:50%; padding:12px; background:#222; border:1px solid #333; color:white; border-radius:8px;">
        </div>
        <button class="action-btn" onclick="data.save()" style="margin-top:15px;">Save</button>
        <button onclick="document.getElementById('modal').style.display='none'" style="width:100%; padding:10px; background:none; border:none; color:#f44336; margin-top:5px;">Cancel</button>
    </div>

    <!-- PROFILE & SETTINGS -->
    <div id="settings" class="full-page">
        <div class="fp-head"><i class="fas fa-arrow-left" onclick="this.parentElement.parentElement.style.display='none'"></i> <h3>Profile & Settings</h3></div>
        <div class="fp-body">
            <div class="profile-card">
                <i class="fas fa-user-circle" style="font-size:50px; color:var(--secondary); margin-bottom:10px;"></i>
                <h3 id="prof-id">...</h3>
                <div style="margin:10px 0;"><span class="sub-badge" id="prof-status">TRIAL</span></div>
                <p id="prof-exp" style="font-size:12px; color:#aaa; margin-bottom:15px;">Expires on: ...</p>
                <button class="action-btn" style="background:var(--accent); font-size:14px;" onclick="pay.showPaymentScreen(false)">âš¡ Extend / Buy Premium</button>
            </div>

            <h4 style="color:var(--primary); margin-bottom:10px;">Preferences</h4>
            <label>Currency</label><select id="set-cur" class="auth-inp" style="margin:5px 0; text-align:left;"><option value="à§³">à§³ (BDT)</option><option value="â‚¹">â‚¹ (INR)</option><option value="$">$ (USD)</option></select>
            <label>Daily Salary</label><input type="number" id="set-sal" class="auth-inp" style="margin:5px 0; text-align:left;" placeholder="500">
            <label>Overtime Rate</label><input type="number" id="set-otr" class="auth-inp" style="margin:5px 0; text-align:left;" placeholder="50">
            <button class="action-btn" onclick="settings.save()" style="margin-top:10px;">Save Settings</button>

            <hr style="border-color:var(--border); margin:20px 0;">
            <h4 style="color:white; margin-bottom:10px;">Legal & Support</h4>
            <button class="legal-btn" onclick="legal.show('privacy')"><span>Privacy Policy</span> <i class="fas fa-chevron-right"></i></button>
            <button class="legal-btn" onclick="legal.show('refund')"><span>Refund Policy</span> <i class="fas fa-chevron-right"></i></button>
            <button class="legal-btn" onclick="legal.show('terms')"><span>Disclaimer</span> <i class="fas fa-chevron-right"></i></button>
            <button class="legal-btn" onclick="location.href='mailto:nitai.grp00@gmail.com'"><span>Contact Support</span> <i class="fas fa-envelope"></i></button>
        </div>
    </div>

    <!-- REPORTS -->
    <div id="reports" class="full-page">
        <div class="fp-head"><i class="fas fa-arrow-left" onclick="this.parentElement.parentElement.style.display='none'"></i> <h3>Reports</h3></div>
        <div class="fp-body">
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="date" id="r-start" class="auth-inp" style="margin:0; font-size:14px;">
                <input type="date" id="r-end" class="auth-inp" style="margin:0; font-size:14px;">
            </div>
            <button class="action-btn" onclick="reports.gen()">Generate</button>
            <div id="r-out" style="margin-top:20px;"></div>
        </div>
    </div>

    <!-- LEGAL MODAL -->
    <div id="legal-modal">
        <div class="legal-content">
            <button class="legal-close" onclick="document.getElementById('legal-modal').style.display='none'">&times;</button>
            <h3 id="legal-title">Policy</h3>
            <div id="legal-body" style="font-size:13px; color:#aaa;"></div>
        </div>
    </div>

    <script>
        // DOMAIN LOCK
        (function() {
            var allowed = "nitaistudio.github.io"; 
            var host = window.location.hostname;
            if (host && host !== allowed && host !== "localhost" && host !== "127.0.0.1") {
                document.body.innerHTML = "<div style='display:flex;height:100vh;justify-content:center;align-items:center;background:#000;color:red;flex-direction:column;text-align:center;'><h1>ðŸš« Access Denied</h1><p>Code Theft Detected</p></div>";
                throw new Error("Unauthorized Domain");
            }
        })();

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDf1C_8igKRvV6E3bA2L-zjWabhPb6k25U",
            authDomain: "duty-tracker-5bc76.firebaseapp.com",
            databaseURL: "https://duty-tracker-5bc76-default-rtdb.firebaseio.com",
            projectId: "duty-tracker-5bc76",
            storageBucket: "duty-tracker-5bc76.firebasestorage.app",
            messagingSenderId: "695532299998",
            appId: "1:695532299998:web:f3b02fba3bb087f093c44f"
        };
        try { firebase.initializeApp(firebaseConfig); } catch(e) {}
        const db = firebase.database();
        const RZP_KEY = "rzp_live_RyuF0DQNLGiAH2";

        const s = { uid: null, date: new Date(), data: {}, sub: 0, conf: { cur: 'à§³', sal: 0, otr: 0 } };
        let sel = { d: null, t: null };
        let paypalRendered = false;

        window.onload = () => {
            setTimeout(() => {
                document.getElementById('splash').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('splash').style.display = 'none';
                    const id = localStorage.getItem('dt_id');
                    if(id && id !== "null") app.start(id); 
                    else document.getElementById('auth-screen').style.display = 'flex';
                }, 800);
            }, 3000);
        };

        const app = {
            login: () => {
                const ph = document.getElementById('auth-phone').value.trim();
                if(ph.length > 5) {
                    s.uid = ph; 
                    document.getElementById('auth-screen').style.display = 'none'; 
                    localStorage.setItem('dt_id', ph);
                    app.start(ph);
                } else alert("Invalid Number");
            },
            start: (id) => { 
                s.uid = id;
                db.ref('u/' + s.uid).on('value', snap => {
                    const v = snap.val() || {};
                    s.data = v.att || {};
                    if (!v.subExp) {
                        const trialEnd = Date.now() + (30 * 24 * 60 * 60 * 1000);
                        db.ref('u/' + s.uid + '/subExp').set(trialEnd);
                        s.sub = trialEnd;
                    } else { s.sub = v.subExp; }
                    
                    // Fixed: Load settings correctly and persist them
                    if(v.conf) {
                        s.conf = { ...s.conf, ...v.conf };
                        document.getElementById('set-cur').value = s.conf.cur || 'à§³';
                        document.getElementById('set-sal').value = s.conf.sal || '';
                        document.getElementById('set-otr').value = s.conf.otr || '';
                    }
                    app.checkSub();
                });
            },
            checkSub: () => {
                const now = Date.now();
                if(now > s.sub) {
                    pay.showPaymentScreen(true);
                } else {
                    document.getElementById('payment-screen').style.display = 'none';
                    document.getElementById('main-app').style.display = 'block';
                    cal.render();
                }
            }
        };

        const pay = {
            showPaymentScreen: (isLocked) => {
                document.getElementById('payment-screen').style.display = 'flex';
                document.getElementById('pay-close-btn').style.display = isLocked ? 'none' : 'flex';
                if(isLocked) document.getElementById('main-app').style.display = 'none';
                
                // FORCE RENDER PAYPAL
                setTimeout(() => pay.initPayPal(), 100); 
            },
            razorpay: (amt, plan) => {
                const options = {
                    "key": RZP_KEY, "amount": amt * 100, "currency": "INR",
                    "name": "Duty Tracker Pro", "description": plan,
                    "handler": function (response) { pay.success(plan, response.razorpay_payment_id); },
                    "prefill": { "contact": s.uid }, "theme": { "color": "#6C63FF" }
                };
                const rzp1 = new Razorpay(options); rzp1.open();
            },
            initPayPal: () => {
                if(paypalRendered) return;
                
                // Clear previous
                document.getElementById('paypal-btn-monthly').innerHTML = "";
                document.getElementById('paypal-btn-yearly').innerHTML = "";

                if (typeof paypal !== 'undefined') {
                    const style = { layout: 'horizontal', color: 'gold', height: 40, label: 'pay', tagline: false };

                    // Monthly
                    paypal.Buttons({
                        style: style,
                        createOrder: (d, a) => a.order.create({ purchase_units: [{ amount: { value: '0.10' } }] }),
                        onApprove: (d, a) => a.order.capture().then(det => pay.success('monthly', det.id))
                    }).render('#paypal-btn-monthly');

                    // Yearly
                    paypal.Buttons({
                        style: style,
                        createOrder: (d, a) => a.order.create({ purchase_units: [{ amount: { value: '0.50' } }] }),
                        onApprove: (d, a) => a.order.capture().then(det => pay.success('yearly', det.id))
                    }).render('#paypal-btn-yearly');

                    paypalRendered = true;
                }
            },
            success: (plan, pid) => {
                const now = Date.now();
                let add = (plan === 'yearly') ? 31536000000 : 2592000000;
                let newExp = (now > s.sub ? now : s.sub) + add;
                db.ref('u/' + s.uid + '/subExp').set(newExp).then(() => {
                    alert("Payment Successful!"); location.reload();
                });
            }
        };

        const legal = {
            show: (type) => {
                const titleMap = { 'privacy': 'Privacy Policy', 'refund': 'Refund Policy', 'terms': 'Disclaimer' };
                const textMap = {
                    'privacy': 'Duty Tracker Pro respects your privacy. We collect your mobile number solely for account authentication. Your data is stored securely on Google Firebase and never shared. Payments are processed via Razorpay/PayPal.',
                    'refund': 'All payments are final. However, if you face technical issues preventing access to premium features, please contact support within 24 hours for assistance.',
                    'terms': 'This app is provided "as is". Duty Tracker Pro is not responsible for any financial losses due to calculation errors. Users are advised to verify salary calculations manually.'
                };
                document.getElementById('legal-title').innerText = titleMap[type];
                document.getElementById('legal-body').innerText = textMap[type];
                document.getElementById('legal-modal').style.display = 'flex';
            }
        };

        const ui = {
            openProfile: () => {
                document.getElementById('settings').style.display = 'flex';
                document.getElementById('prof-id').innerText = s.uid;
                const expDate = new Date(s.sub);
                const daysLeft = Math.ceil((s.sub - Date.now()) / (1000 * 60 * 60 * 24));
                document.getElementById('prof-exp').innerText = `Valid till: ${expDate.toDateString()}`;
                
                if(daysLeft > 30) {
                    document.getElementById('prof-status').innerText = "PREMIUM";
                    document.getElementById('prof-status').style.background = "#4caf50";
                } else {
                    document.getElementById('prof-status').innerText = `${daysLeft} DAYS LEFT`;
                    document.getElementById('prof-status').style.background = "#ff9800";
                }
            }
        };

        const cal = {
            getIso: (y, m, d) => `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`,
            render: () => {
                const y=s.date.getFullYear(), m=s.date.getMonth();
                document.getElementById('month-txt').innerText = new Date(y, m).toLocaleString('default', { month: 'long', year: 'numeric' });
                const grid = document.getElementById('calendar-grid'); grid.innerHTML='';
                const fDay = new Date(y,m,1).getDay(), lDate = new Date(y,m+1,0).getDate();
                for(let i=0; i<fDay; i++) grid.innerHTML += `<div></div>`;
                for(let i=1; i<=lDate; i++) {
                    const iso = cal.getIso(y, m, i);
                    const ent = s.data[iso];
                    const el = document.createElement('div'); el.className = 'day-cell ' + (ent ? 'bg-'+ent.t : '');
                    if(iso === new Date().toISOString().split('T')[0]) el.style.border = '2px solid var(--secondary)';
                    el.innerHTML = `<span style="font-weight:bold">${i}</span>`;
                    if(ent) {
                        el.innerHTML += `<div style="font-size:10px; margin-top:5px; opacity:0.8">${ent.t}</div>`;
                        if(ent.ot) el.innerHTML += `<div style="font-size:9px; color:#ffff00">OT: ${ent.ot}</div>`;
                    }
                    el.onclick=()=> {
                        sel.d = iso;
                        document.getElementById('modal-date').innerText = new Date(iso).toDateString();
                        document.getElementById('modal').style.display='block';
                        document.querySelectorAll('.type-btn').forEach(b=>b.classList.remove('active'));
                        if(ent) document.getElementById('inp-ot').value = ent.ot || '';
                    };
                    grid.appendChild(el);
                }
            },
            move: (v) => { s.date.setMonth(s.date.getMonth()+v); cal.render(); }
        };

        const data = {
            set: (t, btn) => { sel.t = t; document.querySelectorAll('.type-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); },
            save: () => {
                if(!sel.t && !document.getElementById('inp-ot').value) return alert("Select Type");
                const p = { t: sel.t || 'Present', ot: document.getElementById('inp-ot').value, lt: document.getElementById('inp-late').value };
                db.ref(`u/${s.uid}/att/${sel.d}`).set(p).then(() => {
                    alert("Saved!");
                    document.getElementById('modal').style.display='none';
                });
            }
        };

        const settings = {
            save: () => {
                s.conf.cur = document.getElementById('set-cur').value;
                s.conf.sal = parseFloat(document.getElementById('set-sal').value) || 0;
                s.conf.otr = parseFloat(document.getElementById('set-ot-rate').value) || 0;
                
                // Fixed: Save Settings to Firebase correctly
                db.ref(`u/${s.uid}/conf`).set(s.conf).then(()=>alert("Settings Saved"));
            }
        };

        const reports = {
            gen: () => {
                const sD=document.getElementById('r-start').value, eD=document.getElementById('r-end').value;
                if(!sD) return alert("Select Dates");
                let pres=0, otHrs=0, tot=0;
                const start=new Date(sD), end=new Date(eD);
                for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)) {
                    const iso = d.toISOString().split('T')[0]; tot++;
                    const e = s.data[iso];
                    if(e) { if(['Present','Holiday'].includes(e.t)) pres++; otHrs += parseFloat(e.ot||0); }
                }
                const earn = (pres * s.conf.sal) + (otHrs * s.conf.otr);
                document.getElementById('r-out').innerHTML = `<div style="background:#222; padding:15px; border-radius:10px;">Total Days: ${tot} <br> Paid Days: ${pres} <br> OT: ${otHrs} Hrs <hr> <h3>Total: ${s.conf.cur} ${earn}</h3></div>`;
            }
        };

        // PWA Install Logic
        let deferredPrompt;
        const pwaBtn = document.getElementById('pwa-install-btn');
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); deferredPrompt = e; pwaBtn.style.display = 'block';
        });
        const pwa = {
            install: () => {
                if(deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((c) => { if(c.outcome==='accepted') pwaBtn.style.display='none'; deferredPrompt = null; });
                }
            }
        };
        if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');

    </script>
</body>
</html>